{% extends "base.html" %}
{% block title %}Research · QuantSight{% endblock %}
{% block hero %}
  <div class="row align-items-center">
    <div class="col-lg-9">
      <h1 class="display-6 fw-semibold mb-2 text-white">Research</h1>
      <p class="lead text-white-50 mb-0">Multi-ticker portfolio backtest, weights, factor exposures, and signal diagnostics—on one page.</p>
    </div>
  </div>
{% endblock %}
{% block content %}
<div class="content-card">
  <h2 class="h4 mb-3">Portfolio Backtest</h2>
  <div class="row g-2">
    <div class="col-md-4">
      <label class="form-label">Tickers (comma separated)</label>
      <input id="pf-tickers" class="form-control" type="text" value="AAPL,MSFT,GOOGL,AMZN" />
    </div>
    <div class="col-md-2">
      <label class="form-label">Start</label>
      <input id="pf-start" class="form-control" type="date" value="2015-01-01" />
    </div>
    <div class="col-md-3">
      <label class="form-label">Signal</label>
      <input id="pf-signal" class="form-control" type="text" value="prob_up_1d" />
      <div class="form-text">Any model <code>prob_*</code> or factor (e.g., <code>mom_20</code>)</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">Allocator</label>
      <select id="pf-allocator" class="form-select">
        <option value="equal_weight">equal_weight</option>
        <option value="risk_parity">risk_parity</option>
        <option value="mean_variance">mean_variance</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Rebalance</label>
      <select id="pf-rebalance" class="form-select">
        <option value="weekly">weekly</option>
        <option value="monthly">monthly</option>
        <option value="daily">daily</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Cost (bps)</label>
      <input id="pf-cost" class="form-control" type="number" value="5" />
    </div>
    <div class="col-md-auto d-flex align-items-end">
      <button id="pf-run" class="btn-elev">Run</button>
    </div>
    <div class="col-md-auto d-flex align-items-end">
      <div class="form-check form-switch me-3">
        <input class="form-check-input" id="pf-show-decay" type="checkbox">
        <label class="form-check-label" for="pf-show-decay">IC vs Horizon</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" id="pf-show-quant" type="checkbox">
        <label class="form-check-label" for="pf-show-quant">Quantile Long-Short</label>
      </div>
    </div>
  </div>
</div>
<div class="row g-3">
  <div class="col-lg-8">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Portfolio Equity</div>
        <div id="pf-equity" style="height: 360px;"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Metrics</div>
        <div id="pf-metrics" class="small"></div>
      </div>
    </div>
  </div>
</div>
<div class="soft-card card mt-3">
  <div class="card-body">
    <div class="text-muted small mb-2">Weights Heatmap</div>
    <div id="pf-weights" style="height: 420px;"></div>
  </div>
</div>
<div class="soft-card card mt-3">
  <div class="card-body">
    <div class="text-muted small mb-2">Fama–French Factor Exposures</div>
    <div id="pf-ff" style="height: 320px;"></div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-lg-12">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Rolling Drawdown</div>
        <div id="pf-roll-dd" style="height: 280px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted small">Factors Preview (Primary Ticker)</div>
          <div class="form-check form-switch">
            <input class="form-check-input" id="pf-show-factors" type="checkbox">
            <label class="form-check-label" for="pf-show-factors">Load</label>
          </div>
          <div class="form-check form-switch ms-3">
            <input class="form-check-input" id="pf-show-pca" type="checkbox">
            <label class="form-check-label" for="pf-show-pca">PCA</label>
          </div>
        </div>
        <div id="pf-factors" style="max-height:280px; overflow:auto; font-size:12px; font-family:monospace;"></div>
        <div id="pf-pca" class="mt-2 small" style="max-height:140px; overflow:auto;"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted small">Single Ticker Risk Metrics</div>
          <div class="form-check form-switch">
            <input class="form-check-input" id="pf-show-risk" type="checkbox">
            <label class="form-check-label" for="pf-show-risk">Load</label>
          </div>
        </div>
        <div id="pf-risk-metrics" class="small mb-2"></div>
        <div id="pf-risk-roll-sharpe" style="height:160px;"></div>
        <div id="pf-risk-roll-vol" style="height:160px;"></div>
      </div>
    </div>
  </div>
</div>


<div class="row g-3 mt-3">
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Rolling Sharpe (63d)</div>
        <div id="pf-roll-sharpe" style="height: 280px;"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Rolling Volatility (63d)</div>
        <div id="pf-roll-vol" style="height: 280px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Return Attribution (6m) — Σ w·r</div>
        <div id="pf-attr" style="height: 300px;"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Return Attribution (6m) — % of Portfolio</div>
        <div id="pf-attr-pct" style="height: 300px;"></div>
      </div>
    </div>
  </div>
</div>

<div id="pf-extras" class="row g-3 mt-1" style="display:none;">
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">IC vs Holding Horizon</div>
        <div id="pf-ic" style="height: 300px;"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="soft-card card h-100">
      <div class="card-body">
        <div class="text-muted small mb-2">Quantile Long-Short (Q5 − Q1)</div>
        <div id="pf-qs" style="height: 300px;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
<!-- No extra scripts needed - PF auto-initializes from app.js -->